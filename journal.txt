--- 05/09/25 ---

Trying to fit interstitial calcite dissolution obsered in SAE1. Pest++ wants SA_VF power to be ~15. I don't think this is reasonable.

Looks like value for Calc_is_SA_VF can't be set below 1 or it shits the bed. However it's happy to fit any value 1 or above reasonably well. Unclear exactly why this would be from reading the pflotran documentation. A/A0 = (phi/phi0)^n, where n=2/3 would be a sphere. But we apparently need A to decrease faster than that?

calc_is_SA_VF (fixed)	calc_is_sa	calc_is_vf
1	0.0400807	0.000548512
2	0.0636064	0.000711128
5	0.105053	0.00122044

All of these combinations do a decent job at reproducing the data. SA_VF = 1 is basically a straight line in Ca and pH outputs, and higher numbers show more of an exponential decay, which is probably a better fit to the data.

Running fits to all 4 experiments currently hangs while running SAE2 for some reason. pflotran fails for sae2 earlier in the run too.

--- 11/09/25 ---

Maybe I can try to hone in on the calcite surface parameters by fitting those and Ca++ and pH first, before trying SiO2?


--- 12/09/25 ---

Fit some Calc parameters:

  Calc_alpha:          1.8387       
  Calc_SA:             2.71572      
  Calc_SA_VF:          3.57794      
  Calc_is_alpha:       1            
  Calc_is_SA:          0.0857075    
  Calc_is_SA_VF:       2            
  Calc_is_VF:          0.000744927  
  
Now trying to fit SiO2 parameters independently (fitting only to SiO2 abundances)

Some apparent strange behaviour in pestpp where certain parameters aren't adjusted at all from their initial values?

--- 15/09/25 ---

Current confusion is how the different derinc types and transformations affect parameters such as SA_VF which can be around or close to zero.

"absolute" vs "relative" increment type for parameter groups, and how that interacts with parameter transformation and change limiters...

--- 16/09/25 ---

I have a setup that seems to reproduce the experiments to what I would consider an acceptable degree.

Major change has been to alter SiO2 mineral surface area function to "constant" rather than "volume fraction power". There were too many issues with SiO2_SA_VF crashing pflotran, quite likely because the initially low SiO2_VF (currently using 1e-4) means that relative VF changes really quickly. Here are the floating parameters and their current values:


  Calc_alpha:          1.8387       
  Calc_SA:             2.71572      
  Calc_SA_VF:          3.57794      
  Calc_is_alpha:       1            
  Calc_is_SA:          0.0857075    
  Calc_is_SA_VF:       2            
  Calc_is_VF:          0.000744927
  SiO2_alpha:          -0.351987
  SiO2_SA:             52534.3

If I set SiO2_VF to active it doesn't really seem to want to change it anyway. - because SA doesn't change with VF?

A full inversion of pH, Ca and SiO2 data gives the following:

                name          prior_mean         prior_stdev   prior_lower_bound   prior_upper_bound           post_mean          post_stdev    post_lower_bound    post_upper_bound
          sio2_alpha            -1.00000             1.22500            -3.45000             1.45000           -0.351776           0.0103589           -0.372494           -0.331059
             sio2_sa             4.00000             1.75000            0.500000             7.50000             4.72114           0.0702856             4.58057             4.86171
          calc_alpha             1.00000             2.47500            -3.95000             5.95000             1.87138             2.47349            -3.07559             6.81835
             calc_sa             1.47712             1.25000            -1.02288             3.97712            0.434582           0.0413625            0.351857            0.517307
          calc_sa_vf             3.60000             6.25000            -8.90000             16.1000             3.50107            0.187811             3.12545             3.87670
the above parameter uncertainty summary was written to file 'pest_control.par.usum.csv'

Suggesting calc_alpha is not tightly constrained, we should probably leave it at one.

--- 24/09/25 ---

Have been playing around in the sandbox folder, trying out a 3D implementation of the model using PFLOTRAN's cyclindrical co-ordinate support. It seems to be working ok. Takes about 15 seconds to run a model vs ~1 second for the 1D model. 

Will require rewriting of the template writing scripts to adjust the instructions files I believe, but should be fine after that?

Had to edit config file to change which lines are being processed into "results.txt" for each PFLOTRAN run, and made instructions writer pull first number from each line.

Changed "pflotran.master" to the 3D version and saved old version as "pflotran_1D.master"
 
First run seemed to work - tuning a single parameter on SAE1 took 20 minutes though

SAE1 tuning for Calc_is parameters seems to have similar behaviour to 1D. Calc_is_SA_VF wants to go to silly levels, I'm gonna fix it at 2. 

40 minutes to tune 3 parameters on SAE1, suggests I may have to look into parallelisation...

Added a script in utils "batch_run_pflotran.py" that calls up to 4x run_pflotran.py in parallel. Hopefully will speed things up.

--- 25/09/25 ---

Running PFLOTRAN models in parallel is making things about 4x faster as expected. I ran a full inversion that fits the data well with the current parameters:

                name          prior_mean         prior_stdev   prior_lower_bound   prior_upper_bound           post_mean          post_stdev    post_lower_bound    post_upper_bound
          sio2_alpha                  -1               1.225               -3.45                1.45           -0.374358           0.0108667           -0.396091           -0.352624
             sio2_sa                   4                1.75                 0.5                 7.5             4.79696           0.0703375             4.65628             4.93763
             calc_sa             1.47712                1.25            -1.02288             3.97712            0.239429           0.0439576            0.151513            0.327344
          calc_sa_vf                 3.6                6.25                -8.9                16.1             1.89957            0.122632              1.6543             2.14483

With    calc_is_vf = 0.00127399
	calc_is_sa_vf = 2
	calc_is_sa = 0.14996

Run040 is this run!
	
An observation is that the SiO2 drop in SAE3 is fitted much better than in SAE4.
This is despite the fact that there probably isn't any actual amorphous silica precipitating in SAE3?
I believe it's really all clay minerals in sAE3... Maybe I need to add kaolinite (& albite) back into the model?

I also updated run_pflotran.py so that it will grab the first number from the last line of the results, regardless of how many lines there are.
I want to use this to investigate if the number of the z-cells affects results.
I think it could be possible that closer spacing of the z-cells at the inlet could give markedly different results?

Running with 40 z-cells instead of 20 didn't make much difference

Another idea is to put constraints on where Am-Si precipitates using SEM photos and figuring out a proxy to the VF in the model based on distance from the inlet?

--- 26/09/25 ---

Thinking about porosity, perhaps trying to incorporate "update_porosity".

This could be helpful because whilst SiO2(am) doesn't like to update its surface area with VF, it might like to update it with porosity?
Porosity should change relatively much more slowly. Although calcite will also be dissolving while it is precipitating. Unclear.

Anyway, if you just put update_porosity in then it starts to calculate porosity as a function of all of the mineral vol_fracs.
This is a problem as at the moment we only have calcite and SiO2(am) as mineraly, so porosity jumps straight to >90%
Tweaked the template writer to fill the rest of the rock bulk with quartz, and the template sets quartz kinetic rate to 0.0 so it shouldn't react.

This seems to mess something up in the model though, even before we incorporate update_porosity. 
It seems calcite area is going to infinity somewhere? - SAE1 seems to work normally.

Trying to refit from the beginning (starting with calc_is and sae1 again)

Problem with this now is due to 3D implementation SAE1 tuning takes a long time!

Ok SAE1 results look similar to before:

     Parameter            

        Name         Value

    ------------  ------------

    calc_is_sa        0.145844

    calc_is_vf      0.00126853
    
Interestingly, full inversion results look quite different for Ca:

     Parameter            
        Name         Value
    ------------  ------------
    sio2_alpha       -0.374061
    sio2_sa            69810.2
    calc_sa           0.374059
    calc_sa_vf        0.199701

This actually fits the flattening out of the SAE3 Ca curve much better, as it corresponds to the point at which the added calcite is fully dissolved.
It does compromise  the fit of SAE4 a bit but overall I like it better.
SiO2_alpha strongly correlated with sio2_sa

--- 29/09/25 ---

I had a go at implementing kaolinite on the weekend. And trying to get the final SiO2(am)_VF added as a constraint. This is currently just shoehorned inelegantly into pest_control.master.
Eventually we would want SiO2(am)_VF in SAE3 to be close to zero, and kaolinite to precipitate instead.
Oh, I also changed the initial SiO2(aq) of each experiment to reflect what the blanks actually are. I could do this for all species but I don't think that's important.

--- 01/10/25 ---

I have finally got round to moving the git repo to github.
I also decided to christen the project - INGRESS
INvestigation/INversion of Geothermal Reinjection Experiments (for) Subsurface Simulation
Name is quite cringe and maybe subject to change

--- 09/10/25 ---

Just messing around really - trying to fit all calcite parameters across 4 experiments. It wants to push calc_is_vf to unreasonable levels.

The amount of ca dissolved in SAE3 requires a minimum VF of calc + calc_is of 0.0086
(calculation in sae google sheet)

--- 10/10/25 ---

Overnight inversion for sio2 and kaol parameters actually fits the data pretty well.

     Parameter            
        Name         Value
    ------------  ------------
    sio2_alpha       -0.51632703098
    sio2_sa           7.12172e+03
    calc_sa           0.584059
    calc_sa_vf        0.199701
    calc_is_vf        0.00226853
    calc_is_sa        0.145844
    calc_is_sa_vf     3.5
    kaol_sa           7.73840e-03 
    
--- 30/10/25 ---

Starting to think about a reservoir model. Making a synthetic reservoir using gstools python package seems like a good starting point. 
Putting this in field_generator.py

Plan is to have a field generator that will make a plausible looking porosity, permeability, field which can maybe have variable calcite too.
Ideally we can generate a pflotran input file using jinja2 that can be easily scalable in terms of number of cells.

--- 31/10/25 ---

I also need to make a PFLOTRAN model that actually works with the reinjection geometry.

--- 03/11/25 ---
 
I have a base case reinjection model now in the sandbox which appears to have the correct reinjection geometry, although nothing is really scaled properly yet.

I'm currently using the FLOW_CONDITION type RATE scaled_volumetric_rate to inject fluid from the well feedzone.
This may not be how I eventually want to do it as I imagine keeping the pressure fixed and allowing flow rate to respond to porosity, permeability changes is more useful.

--- 05/11/25 ---

Need to scale the reinjection model properly, and implement the random field generation, and make grid log-scaled.

In response to the constant pressure vs constant flow rate point above, I note that the cylindrical injection example in the pflotran readme uses an origin x=0.3, so the well is basically outside the model domain?

Have swtiched to an iterative solver for the reservoir model, which should allow easy multithreading with mpirun as the model scales up.

--- 06/11/25 ---

Rescaling reservoir model

r = 20km (x-axis)
z = 300m
feedzone = 100m - 200m
t = 5 yrs (can increase later)
output_period = 100h (438 steps)
injection rate = ?
perm_x = 1e-12 (this is too high for greywacke but reasonable if fractured)
perm_z = 1e-13

reservoir pressure = 1e7 Pa (=100 bar, with hydrostatic gradient)
injection pressure = 1.5e7 Pa (=150 bar)

--- 07/11/25 ---

Working on porosity field generation, have switched reservoir.in to use a pressure boundary condition from an x-origin of 0.1 m to represent the feedzone.
Seems to still give sensible results

--- 15/11/25 ---

After discussions at NZGW, reinjection model seems to be acceptable. One key outstanding issue is that reservoir temp should be higher than 150 - need a non-isothermal model.

Set base temp to 250 and cap temp to 200. Seems to be working.

--- 18/11/25 ---

Setting up template writing scripts for reservoir.

--- 19/11/25 ---

Set up script to generate porosity field and write to .h5 file using h5py.
Appears not to work as intended right now because the initial porosity gets overwritten at t=0.
UPDATE_POROSITY calculates initial phi as a function of mineral volume fractions.
I think I can alter the approach simply by providing a qtz_VF.h5 file or similar.

--- 20/11/25 ---

Fully implemented generation of synthetic heterogeneous porosity and calcite in build_reservoir_model.py
Everything is going in a reservoir.h5 file with the datasets under different names.

Ran some tests scaling up resolution on the laptop.
Appears to be some issues with convergence once cell count gets >10,000
Timestep becomes prohibitively small, particularly at model start and when permeability drops close to zero.
Could be that cell size gets very small near injection point?

--- 21/11/25 ---

Put reservoir model workflow into res_workflow.py, combining build_reservoir_model and plot_vtk_heatmap.

Injection decline curve plotting added to res_workflow. Inj decline seems under default parameters to be slightly sigmoid, rather than parabolic as apparently observed in real wells. Will need to play around with setup to see how that affects injection decline.

--- 25/11/25 ---

I think we need to consider externally how reactive surface area might scale with porosity going from expt -> reservoir models.

Constant surface area of SiO2(am) might be leading to observed linear(ish) injectivity decline? 

Tweaked permeability calcs (n = 0.66 rather than n=2.5 seems more sensible?)

Prettified the output videos as well so log scale can be visualised

--- 27/11/25 ---

Added permeability dataset to .h5 file generation

--- 02/12/25 ---

Reservoir model is looking pretty good now. Inj decline curve looks plausible.

Does calcite_is need to be heterogeneous? How do we incorporate that alongside the base calcite distribution?

Fixed issue with injectivity units - plot is now in tonnes/day and labelled as such.
Values seem plausible but will check with JM.

Adjusted initial mineral surface areas to account for porosity difference using:
a = a0*((1-phi)/(1-phi0))**n
where n=2/3
This slows inj decline right down, not sure if useful?

POROSITY_RATIO surface area function appears to not be working as per pflotran user guide. Think it is as above eqn instead?


